{% extends "AppBundle::layout.html.twig" %}

{% block body %}
    {{ parent() }}

    <section class="content">
        <div class="container-fluid">
            <div class="block-header">
                <h2>
                    DOCUMENTS A GENERER
                </h2>
            </div>
            <!-- Table des documents à générer -->
            <div id="block-table-document-genere" class="row clearfix">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="card">
                        <div class="header">
                            <h2 class="col-xs-4">
                                Liste des documents à générer
                            </h2>
                            <div class="col-xs-6 right-side">
                                {#<a href="{{ path('go_to_fichier') }}" type="button"#}
                                   {#class="btn btn-primary waves-effect">Ajouter Fichier</a>#}
                                <button type="button" class="btn btn-primary waves-effect button-new">Nouveau</button>
                            </div>
                        </div>
                        <div class="body">
                            <div class="table-responsive">
                                <table id="table-document-genere"
                                       class="table table-bordered table-striped table-hover dataTable js-exportable">
                                    <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Nom du DAG</th>
                                        <th>Description</th>
                                        <th>Delais transmission</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tfoot>
                                    <tr>
                                        <th>Code</th>
                                        <th>Nom du DAG</th>
                                        <th>Description</th>
                                        <th>Delais transmission</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- #END# Table des DAG -->

            <!-- nouveau DAG -->
            <div id="block-form-document-genere" class="row clearfix hidden">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="card">
                        <div class="header">
                            <h2>
                                Nouveau documents à générer
                            </h2>
                        </div>
                        <div class="body">
                            <form id="form-document-genere" class="form-horizontal">
                                <input type="text" name="id" id="id_dag" class="hidden">
                                <div class="row clearfix">
                                    <div class="col-lg-2 col-md-2 col-sm-4 col-xs-5 form-control-label">
                                        <label for="nom">Nom * </label>
                                    </div>
                                    <div class="col-lg-10 col-md-10 col-sm-8 col-xs-7">
                                        <div class="form-group">
                                            <div class="form-line">
                                                <input type="text" name="nom" id="nom_dag" class="form-control nom"
                                                       placeholder="Veuillez saisir le nom" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row clearfix">
                                    <div class="col-lg-2 col-md-2 col-sm-4 col-xs-5 form-control-label">
                                        <label for="description">Description </label>
                                    </div>
                                    <div class="col-lg-10 col-md-10 col-sm-8 col-xs-7">
                                        <div class="form-group">
                                            <div class="form-line">
                                                <textarea name="description" id="description_dag" cols="30" rows="5"
                                                          class="form-control no-resize description"
                                                          placeholder="Veuillez saisir une description"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row clearfix">
                                    <div class="col-lg-2 col-md-2 col-sm-4 col-xs-5 form-control-label">
                                        <label for="delais">Delais</label>
                                    </div>
                                    <div class="col-lg-10 col-md-10 col-sm-8 col-xs-7">
                                        <div class="form-group">
                                            <div class="form-line">
                                                <input type="date" name="delais" id="delais_dag"
                                                       class="form-control delais"
                                                       placeholder="Veuillez saisir le delais de la transmission"
                                                       required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row clearfix">
                                    <div class="col-lg-2 col-md-2 col-sm-4 col-xs-5 form-control-label">
                                        <label for="statut">Statut</label>
                                    </div>
                                    <div class="col-lg-10 col-md-10 col-sm-8 col-xs-7">
                                        <div class="form-group">
                                            <div class="form-line">
                                                <select name="statut" id="statut_dag">
                                                    <option value="0">false</option>
                                                    <option value="1">true</option>
                                                </select>
                                            </div>
                                        </div>
                                        {#<input type="checkbox" value="0" name="statut" id="statut_dag" class="form-control status">#}
                                    </div>
                                </div>
                                <div class="row clearfix">
                                    <div class="col-lg-offset-2 col-md-offset-2 col-sm-offset-4 col-xs-offset-5">
                                        <button type="button" class="btn btn-primary m-t-15 waves-effect save"><i
                                                    class="fa fa-spinner fa-spin hidden"></i> Enregistrer
                                        </button>
                                        <button type="button" class="btn btn-default m-t-15 waves-effect cancel">
                                            Annuler
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- #END# nouveau type de prestation -->


            <!-- Table des fichier d'un DAG -->
            <div id="block-table-fichiers" class="row clearfix hidden">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="card">
                        <div class="header">
                            <h2 class="col-xs-4">
                                Liste des Fichiers
                            </h2>
                            <div class="col-xs-6 right-side">
                                <button type="button" class="btn btn-primary waves-effect button-fermer">Fermer</button>
                            </div>
                        </div>
                        <div class="body">
                            <div class="table-responsive">
                                <table id="table-fichiers"
                                       class="table table-bordered table-striped table-hover dataTable js-exportable">
                                    <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Nom du fichier</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tfoot>
                                    <tr>
                                        <th>Code</th>
                                        <th>Nom du fichier</th>
                                        <th>Actions</th>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- #END# Table des Fichiers -->

            <!-- Add Fichier -->
            <div id="block-form-add-fichie" class="row clearfix hidden">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="card">
                        <div class="header">
                            <h2>
                                Ajouter un Fichier
                            </h2>
                        </div>
                        <div class="body">
                            <form id="form-add-fichier" class="form-horizontal" enctype="multipart/form-data"
                                  action="{{ path('add_fichier') }}" method="post">
                                <input type="text" name="dag" id="id_dag" class="hidden">
                                <div class="row clearfix">
                                    <div class="col-lg-2 col-md-2 col-sm-4 col-xs-5 form-control-label">
                                        <label for="nom">Fichier *</label>
                                    </div>
                                    <div class="col-lg-10 col-md-10 col-sm-8 col-xs-7">
                                        <div class="form-group">
                                            <div class="form-line">
                                                <input type="file" name="docFile" id="docFile" class="form-control file"
                                                       placeholder="Veuillez choisir le fichier" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row clearfix">
                                    <div class="col-lg-offset-2 col-md-offset-2 col-sm-offset-4 col-xs-offset-5">
                                        <button type="submit" class="btn btn-primary m-t-15 waves-effect save">
                                            <i class="fa fa-spinner fa-spin hidden"></i> Enregistrer
                                        </button>
                                        <button type="button" class="btn btn-default m-t-15 waves-effect cancel">
                                            Annuler
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- #END# Add Fichier -->
        </div>
    </section>
{% endblock %}

{% block javascript %}
    {{ parent() }}
    <script>
        $(function () {
            if ($('.datepicker').length) {
                $('.datepicker').bootstrapMaterialDatePicker({
                    format: 'DD MMMM YYYY',
                    clearButton: true,
                    weekStart: 1,
                    time: false,
                    lang: 'fr'
                });
            }

            //Exportable table
            table_tp = $('#table-document-genere').DataTable({
                "language": {
                    "url": Routing.getBaseUrl() + "/plugins/jquery-datatable/i18n/French.json",
                    buttons: {
                        copy: 'Copier',
                        print: 'Imprimer'
                    }
                },
                "ajax": {
                    "url": Routing.generate('list_datatable_dags'),
                    "type": "POST"
                },
                dom: 'Bfrtip',
                responsive: true,
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ],
                "columnDefs": [
                    {
                        "targets": [0, 3],
                        "class": "hide_me"
                    }
                ]
            });

            //click sur le bouton nouveau DAG
            $('#block-table-document-genere .button-new').click(function () {

                $('#form-document-genere input.nom').val('');
                $('#form-document-genere textarea.description').html('');
                $('#form-document-genere input.delais').val('');
                $('#form-document-genere input.statut').val('');

                $('#block-table-document-genere').addClass('hidden');
                $('#block-form-document-genere').removeClass('hidden');
            });

            //click sur le bouton editer DAG
            $('#table-document-genere').on("click", ".edit", function () {

                var id;
                var nom;
                var description;
                var delais;
                var statut;

                var row = jQuery(this).closest('tr');

                var i = 0;
                row.find("td").each(function (cellIndex) {
                    if (i === 0) {
                        id = $(this).html();
                    } else if (i === 1) {
                        nom = $(this).html();
                    } else if (i === 2) {
                        description = $(this).html();
                    } else if (i === 3) {
                        delais = $(this).html();
                        console.log(delais)
                    } else if (i === 4) {
                        statut = $(this).html() == 'true' ? 1 : 0;
                        console.log(statut)
                    }
                    i++;
                });

                $('#id_dag').val(id);
                $('#form-document-genere input.nom').val(nom);
                $('#form-document-genere textarea.description').html(description);
                $('#form-document-genere input.delais').val(delais);
                $('#form-document-genere input.statut').val(statut).trigger('change');

                $('#block-table-document-genere').addClass('hidden');
                $('#block-form-document-genere').removeClass('hidden');
            });

            //click sur le bouton supprimer DAG
            $('#table-document-genere').on("click", ".remove", function () {
                var id;

                var row = jQuery(this).closest('tr');

                var i = 0;
                row.find("td").each(function (cellIndex) {
                    if (i === 0) {
                        id = $(this).html();
                    }
                    i++;
                });

                swal({
                    title: "Attention !",
                    text: "Voulez-vous vraiment Supprimer cet élément ? ",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "Oui",
                    cancelButtonText: "Non",
                    closeOnConfirm: false
                }, function () {

                    $.ajax({
                        'type': 'POST',
                        'url': Routing.generate('delete_dag', {'dag': id}),
                        'dataType': 'JSON',
                        'data': {},
                        'success': function (result) {
                            if (result.data) {
                                swal("Réussi!", "DAG supprimée avec succès", "success");

                                table_tp.ajax.reload();
                            } else {
                                swal("Erreur!", "Erreur lors de la suppression du DAG", "error");
                            }
                        },
                        'error': function () {
                            swal("Erreur!", "Erreur lors de la suppression du DAG", "error");
                        },
                        'beforeSend': function () {
                            $('.sweet-alert button.confirm').html("<i class=\"fa fa-spinner fa-spin\"></i> Oui");
                        },
                        'complete': function () {
                            $('.sweet-alert button.confirm').html("Oui");
                        }
                    });
                });
            });

            //click sur le bouton annuler DAG
            $('#block-form-document-genere .cancel').click(function () {
                $('#block-form-document-genere').addClass('hidden');
                $('#block-table-document-genere').removeClass('hidden');
            });

            //gestion des champs obligatoires sur le formulaire TP
            $("#form-document-genere").validate({
                rules: {
                    nom: "required"
                },
                messages: {
                    nom: "Veuillez entrer un nom"
                }
            });

            //click sur le bouton Enregistrer DAG
            $('#block-form-document-genere .save').click(function () {

                if ($("#form-document-genere").valid()) {
                    var id = $('#id_dag').val();
                    var url = "";
                    var msg_reussite = "";
                    var msg_echec = "";
                    if (id) {
                        //console.log('modification')
                        url = Routing.generate('update_dag', {'dag': id});
                        msg_reussite = "DAG modifiée avec succès";
                        msg_echec = "Problème de modification du DAG";
                    } else {
                        //console.log('enregistrement')
                        url = Routing.generate('add_dag');
                        msg_reussite = "DAG enregistrée avec succès";
                        msg_echec = "Problème d'enregistrement du DAG";
                    }

                    $.ajax({
                        'type': 'POST',
                        'url': url,
                        'dataType': 'JSON',
                        'data': {
                            libelle: $('#nom_dag').val(),
                            description: $('#description_dag').val(),
                            dalaisTransmission: $('#delais_dag').val(),
                            statut: $('#statut_dag').val()
                        },
                        'success': function (result) {
                            if (result.data) {
                                $('#block-form-document-genere').addClass('hidden');
                                $('#block-table-document-genere').removeClass('hidden');
                                swal("Réussi!", msg_reussite, "success");

                                table_tp.ajax.reload();
                            } else {
                                swal("Erreur!", msg_echec, "error");
                            }
                        },
                        'error': function () {
                            swal("Erreur!", msg_echec, "error");
                        },
                        'beforeSend': function () {
                            $('#block-form-document-genere .save i').removeClass('hidden');
                        },
                        'complete': function () {
                            $('#block-form-document-genere .save i').addClass('hidden');
                        }
                    });
                }
            });


            // ----- GZSTION FICHIER (ADD and VIEW)


            //click sur le bouton View Fichiers
            $('#table-document-genere').on("click", ".view-files", function () {
                var id;

                var row = jQuery(this).closest('tr');

                var i = 0;
                row.find("td").each(function (cellIndex) {
                    if (i === 0) {
                        id = $(this).html();
                    }
                    i++;
                });
                console.log(id)

                //Exportable table Fichiers
                table_fichier = $('#table-fichiers').DataTable({
                    "language": {
                        "url": Routing.getBaseUrl() + "/plugins/jquery-datatable/i18n/French.json",
                        buttons: {
                            copy: 'Copier',
                            print: 'Imprimer'
                        }
                    },
                    "ajax": {
                        "url": Routing.generate('list_dag_datatable_fichiers', {'dag': id}),
                        "type": "GET"
                    },
                    dom: 'Bfrtip',
                    responsive: true,
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ],
                    "columnDefs": [
                        {
                            "targets": [0, 3],
                            "class": "hide_me"
                        }
                    ]
                });

                table_fichier.ajax.reload();

                $('#block-table-document-genere').addClass('hidden');
                $('#block-table-fichiers').removeClass('hidden');
            });

            //click sur le bouton nouveau Fermer
            $('#block-table-fichiers .button-fermer').click(function () {
                $('#block-table-document-genere').removeClass('hidden');
                $('#block-table-fichiers').addClass('hidden');
            });

            //click sur le bouton ajouter fichier
            $('#table-document-genere').on("click", ".add-files", function () {
                var id;
                var row = jQuery(this).closest('tr');

                var i = 0;
                row.find("td").each(function (cellIndex) {
                    if (i === 0) {
                        id = $(this).html();
                    }
                    i++;
                });

                var url = '{{ path("update_dag_add_fichier", {'dag': 'id'}) }}';
                url = url.replace("id", id);
                window.location = url;
            });

            //click sur le bouton annuler Add Fichier
            $('#block-form-add-fichier .cancel').click(function () {
                $('#block-form-add-fichier').addClass('hidden');
                $('#block-table-document-genere').removeClass('hidden');
            });

            var files;
            // Add events
            $('input[type=file]').on('change', prepareUpload);

            // Grab the files and set them to our variable
            function prepareUpload(event) {
                files = event.target.files;
                console.log(files)
            }

            //click sur le bouton Enregistrer Add Fichier
            $('#block-form-add-fichier .save').click(function () {

                if ($("#form-add-fichier").valid()) {
                    var id = $('#id_dag').val();
                    var msg_reussite = "";
                    var msg_echec = "";

                    var url = Routing.generate('add_fichier');
                    msg_reussite = "Fichier enregistrée avec succès";
                    msg_echec = "Problème d'enregistrement du Fichier";

                    var data = new FormData();

                    data.append('dag', id);
                    data.append('docFile', files[0]);

                    console.log(data);

                    $.ajax({
                        'type': 'POST',
                        'url': url,
                        'dataType': 'json',
                        'data': {
                            dag: id,
                            docFile: files[0]
                        },
                        'processData': false,
                        'success': function (result) {
                            if (result.data) {
                                $('#block-form-add-fichier').addClass('hidden');
                                $('#block-table-document-genere').removeClass('hidden');
                                swal("Réussi!", msg_reussite, "success");

                                table_tp.ajax.reload();
                            } else {
                                swal("Erreur!", msg_echec, "error");
                            }
                        },
                        'error': function () {
                            swal("Erreur!", msg_echec, "error");
                        },
                        'beforeSend': function () {
                            $('#block-form-add-fichier .save i').removeClass('hidden');
                        },
                        'complete': function () {
                            $('#block-form-add-fichier .save i').addClass('hidden');
                        }
                    });
                }
            });
        })
    </script>
{% endblock %}